var app = angular.module('app',['ui.router']);
app.config(function($stateProvider,$urlRouterProvider, $locationProvider){
	// $locationProvider.hashPrefix('');
	// $urlRouterProvider.otherwise('/');
	// $locationProvider.html5Mode(true);
});

app.constant("configs",{
	domain: 'http://local.icmspratico.com.br'
});

app.factory('GETAPI',function($http, $timeout,configs){

	var ncms;
	var obj = {};

	obj = {
		getNcm: function(scope, callback){
			// $http.get(configs.domain + "/wp-json/wp/v2/" + scope.filtro + "/?search=" + scope.input)
			var input = window.encodeURIComponent(scope.input);
			$http.get(configs.domain + "/wp-json/search_ncm/" + scope.filtro + "/s=" + input)
			.then(function(data){
				obj.save(data);
				callback(data);
			}).then(function(){})
		},
		save: function(data){
			ncms = data;
		}
	}
	return obj;
});
app.filter('unsafe', function($sce) { return $sce.trustAsHtml; });
app.filter('trim', function () {
    return function(value) {
        
    };
});
app.filter('escape', function() {
  return window.encodeURIComponent;
});


app.directive('ngDelay', ['$timeout', function ($timeout) {
    return {
        restrict: 'A',
        scope: true,
        compile: function (element, attributes) {
            var expression = attributes['ngChange'];
            if (!expression)
                return;
            
            var ngModel = attributes['ngModel'];
            if (ngModel) attributes['ngModel'] = '$parent.' + ngModel;
            attributes['ngChange'] = '$$delay.execute()';
            
            return {
                post: function (scope, element, attributes) {
                    scope.$$delay = {
                        expression: expression,
                        delay: scope.$eval(attributes['ngDelay']),
                        execute: function () {
                            var state = scope.$$delay;
                            state.then = Date.now();
                            $timeout(function () {
                                if (Date.now() - state.then >= state.delay)
                                    scope.$parent.$eval(expression);
                            }, state.delay);
                        }
                    };
                }
            }
        }
    };
}]);

app.directive("submit", [function () {
    return {
        scope: {
            submit: "="
        },
        link: function (scope, element, attributes) {
            element.bind("submit", function (loadEvent) {
                return scope.submit(loadEvent);
            });
        }
    }
}]);
app.controller('main', ['$scope', '$http','$timeout','GETAPI',function($scope,$http,$timeout,GETAPI){

	var action = document.location.origin;

	$scope.input = "";
	$scope.action = action;
	$scope.method = "GET";

	$scope.loading = false;
	$scope.filtro = "ncm";
	$scope.getncms = function(){
		$scope.action = "";
		$scope.ncms = "";
		GETAPI.getNcm($scope, function(data){
			$scope.ncms = data.data;
			$scope.loading = false;
		});
		
	}
	$scope.submit = function(){
		if($scope.input.length >= 8){
			console.log('8 NUMEROS');
			window.location = document.location.origin + "/" + $scope.input;
		}else{
			window.location = document.location.origin + "?filtro=" + $scope.filtro + "&" + "s=" + $scope.input;
			$scope.method = "GET";
			var el = angular.element('#form_ncm');
			el.attr('action',document.location.origin);	
			el.attr('method', "GET");	
		}
	}
}]);


app.controller('cnae', ['$scope', '$http','$timeout','GETAPI',function($scope,$http,$timeout,GETAPI){
	
	$scope.loading = false;
	$scope.filtro = "cnae";
	$scope.getcnaes = function(){
		$scope.ncms = "";
		GETAPI.getNcm($scope, function(data){
			$scope.ncms = data.data;
			$scope.loading = false;
		});
	}
	

	var input = $scope.input;

}]);
